name: Clash é…ç½®ç”Ÿæˆå™¨

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  build-config:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: ç”Ÿæˆæ—¶é—´æˆ³
      id: timestamp
      run: |
        current_date=$(date -u +'%Y%m%d-%H%M%S')
        echo "CURRENT_DATE=$current_date" >> $GITHUB_ENV
        echo "TAG_NAME=config-$current_date" >> $GITHUB_ENV

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml requests

    - name: è·å–è®¢é˜…æ•°æ®
      run: |
        mkdir -p sub
        curl -sL "https://raw.githubusercontent.com/Pawdroid/Free-servers/main/sub" -o sub/subscription.txt
        echo "åŸå§‹è®¢é˜…æ•°æ®å¤§å°: $(wc -c < sub/subscription.txt) bytes"

    - name: è§£ç è®¢é˜…å†…å®¹
      run: |
        base64 -d sub/subscription.txt > sub/decoded.txt
        echo "è§£ç åå†…å®¹è¡Œæ•°: $(wc -l < sub/decoded.txt)"

    - name: æ›´æ–°è§„åˆ™è®¢é˜…
      run: |
        mkdir -p rules
        wget -qO rules/China.list https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/China/China.list
        wget -qO rules/Global.list https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Global/Global.list
        wget -qO rules/Unbreak.list https://raw.githubusercontent.com/DivineEngine/Profiles/master/Clash/RuleSet/Unbreak.list

    - name: ç”Ÿæˆé…ç½®æ–‡ä»¶
      run: |
        cat << 'EOF' > generate_config.py
        import base64
        import yaml
        import requests
        import json
        import re
        import logging
        from concurrent.futures import ThreadPoolExecutor

        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s'
        )

        class RuleProcessor:
            TYPE_CONVERSIONS = {
                'IP-CIDR': 'GEOIP',
                'FINAL': 'MATCH',
                'SRC-IP-CIDR': 'IP-CIDR',
                'DST-PORT': 'DST-PORT'
            }

            VALID_TYPES = [
                'DOMAIN', 'DOMAIN-SUFFIX', 'DOMAIN-KEYWORD',
                'IP-CIDR', 'GEOIP', 'MATCH', 'PROCESS-NAME',
                'DST-PORT', 'SRC-PORT'
            ]

            @classmethod
            def process_rule(cls, line):
                line = line.strip()
                original_line = line
                line = line.split('#')[0].strip()
                if not line:
                    return None

                line = re.sub(r'\s+,\s*', ',', line)
                line = line.replace('ï¼Œ', ',')
                line = re.sub(r'([^\s])(DOMAIN|MATCH)', r'\1,\2', line)

                parts = [p.strip() for p in line.split(',')]
                parts = [p for p in parts if p]

                if len(parts) == 2:
                    if parts[0] == 'MATCH':
                        parts.append('ğŸš€ èŠ‚ç‚¹é€‰æ‹©')
                    else:
                        parts.append('ğŸ¯ å…¨çƒç›´è¿')

                if len(parts) != 3:
                    logging.warning(f"æ— æ³•è§£æè§„åˆ™: {original_line}")
                    return None

                rule_type, param, group = parts
                rule_type = cls.TYPE_CONVERSIONS.get(rule_type, rule_type)
                if rule_type not in cls.VALID_TYPES:
                    logging.warning(f"æ— æ•ˆè§„åˆ™ç±»å‹: {original_line}")
                    return None

                param = cls.process_parameter(rule_type, param)
                group = group.split('#')[0].strip()
                return f"{rule_type},{param},{group}"

            @classmethod
            def process_parameter(cls, rule_type, param):
                if rule_type in ['IP-CIDR', 'GEOIP']:
                    param = param.replace('/', 'ï¼').replace('ï¼', '/')
                    if '/' not in param:
                        param += '/32' if '.' in param else '/128'
                elif rule_type in ['DST-PORT', 'SRC-PORT']:
                    param = param.replace('-', ':')
                    if ':' not in param:
                        param += ':' + param
                return param

            @classmethod
            def load_rules(cls, file_path):
                with open(file_path, 'r') as f:
                    return [cls.process_rule(line) for line in f]

        class ClashGenerator:
            def __init__(self):
                self.config = {
                    "port": 7890,
                    "socks-port": 7891,
                    "mode": "Rule",
                    "log-level": "info",
                    "proxies": [],
                    "proxy-groups": [
                        {
                            "name": "ğŸš€ èŠ‚ç‚¹é€‰æ‹©",
                            "type": "select",
                            "proxies": []
                        },
                        {
                            "name": "ğŸ¯ å…¨çƒç›´è¿",
                            "type": "select",
                            "proxies": ["DIRECT"]
                        }
                    ],
                    "rules": []
                }

            def load_proxies(self):
                with open('sub/decoded.txt', 'r') as f:
                    return [line.strip() for line in f if line.startswith('vmess://')]

            def parse_vmess(self, link):
                try:
                    config_str = base64.b64decode(link[8:]).decode()
                    config = json.loads(config_str)
                    return {
                        "name": config["ps"].strip(),
                        "type": "vmess",
                        "server": config["add"],
                        "port": config["port"],
                        "uuid": config["id"],
                        "alterId": config["aid"],
                        "cipher": "auto",
                        "tls": config.get("tls") == "tls",
                        "network": config.get("net", "tcp")
                    }
                except Exception as e:
                    logging.warning(f"è§£æèŠ‚ç‚¹å¤±è´¥: {link[:30]}... - {str(e)}")
                    return None

            def generate(self):
                # å¤„ç†èŠ‚ç‚¹
                vmess_links = self.load_proxies()
                valid_nodes = [node for node in (self.parse_vmess(link) for link in vmess_links) if node]
                self.config["proxies"] = valid_nodes
                self.config["proxy-groups"][0]["proxies"] = [p["name"] for p in valid_nodes]

                # å¤„ç†è§„åˆ™
                with ThreadPoolExecutor() as executor:
                    rule_files = ['rules/China.list', 'rules/Global.list', 'rules/Unbreak.list']
                    results = executor.map(RuleProcessor.load_rules, rule_files)
                
                rules = []
                for result in results:
                    rules.extend([r for r in result if r])
                
                # æ·»åŠ æ ¸å¿ƒè§„åˆ™
                core_rules = [
                    "GEOIP,CN,ğŸ¯ å…¨çƒç›´è¿",
                    "MATCH,ğŸš€ èŠ‚ç‚¹é€‰æ‹©"
                ]
                self.config["rules"] = core_rules + rules

                # å†™å…¥æ–‡ä»¶
                with open('sub/config.yaml', 'w') as f:
                    yaml.dump(self.config, f, allow_unicode=True, width=2147483647)
                logging.info(f"ç”ŸæˆæˆåŠŸ: {len(valid_nodes)}èŠ‚ç‚¹, {len(self.config['rules'])}è§„åˆ™")

        if __name__ == "__main__":
            ClashGenerator().generate()
        EOF

        python generate_config.py

    - name: æœ€ç»ˆéªŒè¯
      run: |
        # éªŒè¯YAMLæ ¼å¼
        python -c "import yaml; yaml.safe_load(open('sub/config.yaml'))"
        
        # æ£€æŸ¥å¿…è¦å…ƒç´ 
        required_items=(
            "proxies"
            "proxy-groups"
            "rules"
            "GEOIP,CN,ğŸ¯ å…¨çƒç›´è¿"
            "MATCH,ğŸš€ èŠ‚ç‚¹é€‰æ‹©"
        )
        for item in "${required_items[@]}"; do
            if ! grep -q "$item" sub/config.yaml; then
                echo "::error::ç¼ºå¤±å¿…è¦å…ƒç´ : $item"
                exit 1
            fi
        done

        echo "âœ… é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"

    - name: åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: sub/config.yaml
        tag_name: ${{ env.TAG_NAME }}
        name: "Clash Config ${{ env.CURRENT_DATE }}"
        generate_release_notes: true
        draft: false
        body: |
          è‡ªåŠ¨ç”Ÿæˆçš„ Clash é…ç½®æ–‡ä»¶
          - ç”Ÿæˆæ—¶é—´: ${{ env.CURRENT_DATE }}
          - èŠ‚ç‚¹æ•°é‡: $(grep -c 'name:' sub/config.yaml)
          - è§„åˆ™æ•°é‡: $(grep -c 'rules:' sub/config.yaml)
          - åŒ…å«åŠŸèƒ½:
            * è‡ªåŠ¨èŠ‚ç‚¹é€‰æ‹©
            * ä¸­å›½å¤§é™†ç›´è¿
            * å¹¿å‘Šæ‹¦æˆªè§„åˆ™
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ¸…ç†å·¥ä½œåŒº
      run: |
        rm -f sub/subscription.txt sub/decoded.txt
        rm -rf rules/
