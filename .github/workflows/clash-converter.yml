name: Clash Config Builder

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©UTCæ—¶é—´3ç‚¹è‡ªåŠ¨æ„å»º

jobs:
  build-config:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Update subconverter
      run: |
        git submodule update --init --remote utils/subconverter
        cd utils/subconverter && git restore pref.ini  # é‡ç½®å¯èƒ½è¢«ä¿®æ”¹çš„é…ç½®

    - name: Decode and prepare subscription
      run: |
        # ä¸‹è½½å¹¶è§£ç è®¢é˜…ï¼ˆå¯¹åº”pref.iniç¬¬14è¡Œinsert_urlï¼‰
        curl -sL "https://raw.githubusercontent.com/Pawdroid/Free-servers/main/sub" | base64 -d > nodes.txt
        
        # è½¬æ¢èŠ‚ç‚¹æ ¼å¼ä¸ºsubconverterå¯è¯†åˆ«æ ¼å¼
        awk '{print "vmess://" $0}' nodes.txt > utils/subconverter/input.txt

    - name: Configure subconverter
      run: |
        # å¯ç”¨è§„åˆ™ç”Ÿæˆå™¨ï¼ˆrule.iniç¬¬36-37è¡Œï¼‰
        sed -i "s/enable_rule_generator=.*/enable_rule_generator=true/" utils/subconverter/config/rule.ini
        sed -i "s/overwrite_original_rules=.*/overwrite_original_rules=true/" utils/subconverter/config/rule.ini

        # é…ç½®è®¢é˜…å¤„ç†ï¼ˆpref.iniç¬¬12-16è¡Œï¼‰
        sed -i "s/^enable_insert=.*/enable_insert=true/" utils/subconverter/pref.ini
        sed -i "s|^insert_url=.*|insert_url=input.txt|" utils/subconverter/pref.ini
        sed -i "s/^prepend_insert_url=.*/prepend_insert_url=true/" utils/subconverter/pref.ini

        # é…ç½®èŠ‚ç‚¹è¿‡æ»¤ï¼ˆpref.iniç¬¬19/26è¡Œï¼‰
        sed -i "s/^exclude_remarks=.*/exclude_remarks=(åˆ°æœŸ|å‰©ä½™æµé‡|æ—¶é—´|å®˜ç½‘|äº§å“|å¹³å°)/" utils/subconverter/pref.ini
        sed -i "s/^enable_filter=.*/enable_filter=true/" utils/subconverter/pref.ini

    - name: Generate config
      run: |
        cd utils/subconverter
        ./subconverter \
          --artifact "clash" \
          --rule "config/rule.ini" \
          --pref "pref.ini" \
          --output "../../sub/config.yaml"
        
        # æ·»åŠ ç”Ÿæˆå…ƒæ•°æ®
        echo -e "\n# Generated at: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> ../../sub/config.yaml
        echo "# Subconverter version: $(git rev-parse --short HEAD)" >> ../../sub/config.yaml

    - name: Validate config
      run: |
        # éªŒè¯æ ¸å¿ƒä»£ç†ç»„ï¼ˆrule.iniç¬¬5è¡Œï¼‰
        if ! grep -q 'ğŸš€ èŠ‚ç‚¹é€‰æ‹©' sub/config.yaml; then
          echo "::error::ä»£ç†ç»„ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
        # éªŒè¯è§„åˆ™å®Œæ•´æ€§ï¼ˆrule.iniç¬¬30/34è¡Œï¼‰
        if ! grep -q 'GEOIP,CN' sub/config.yaml || ! grep -q 'MATCH' sub/config.yaml; then
          echo "::error::è§„åˆ™é›†ç”Ÿæˆä¸å®Œæ•´"
          exit 1
        fi

        # éªŒè¯èŠ‚ç‚¹æ³¨å…¥ï¼ˆpref.iniç¬¬14è¡Œï¼‰
        node_count=$(grep -c 'vmess://' sub/config.yaml)
        if [ "$node_count" -lt 3 ]; then
          echo "::error::èŠ‚ç‚¹æ³¨å…¥æ•°é‡ä¸è¶³"
          exit 1
        fi

    - name: Archive config
      uses: actions/upload-artifact@v3
      with:
        name: clash-config
        path: |
          sub/config.yaml
          utils/subconverter/input.txt
        retention-days: 3

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: sub/config.yaml
        tag_name: config-$(date +%Y%m%d)
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}