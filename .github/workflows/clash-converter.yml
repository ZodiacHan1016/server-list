name: Clash é…ç½®ç”Ÿæˆå™¨

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  build-config:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ç”Ÿæˆæ—¶é—´æˆ³
      id: timestamp
      run: |
        current_date=$(date -u +'%Y%m%d-%H%M%S')
        echo "CURRENT_DATE=$current_date" >> $GITHUB_ENV
        echo "TAG_NAME=config-$current_date" >> $GITHUB_ENV

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml requests

    - name: ç”Ÿæˆé…ç½®æ–‡ä»¶
      run: |
        cat << 'EOF' > generate_config.py
        import base64
        import yaml
        import requests
        import json
        from urllib.parse import urlparse

        class ClashGenerator:
            RULE_SOURCES = [
                "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/China/China.list",
                "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Global/Global.list",
                "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMedia/ChinaMedia.list"
            ]

            def __init__(self):
                self.config = {
                    "port": 7890,
                    "socks-port": 7891,
                    "mode": "Rule",
                    "log-level": "info",
                    "proxies": [],
                    "proxy-groups": [
                        {
                            "name": "ğŸš€ èŠ‚ç‚¹é€‰æ‹©",
                            "type": "select",
                            "proxies": []
                        },
                        {
                            "name": "ğŸ¯ å…¨çƒç›´è¿",
                            "type": "select",
                            "proxies": ["DIRECT"]
                        }
                    ],
                    "rules": []
                }

            def fetch_subscription(self):
                sub_url = "https://raw.githubusercontent.com/Pawdroid/Free-servers/main/sub"
                response = requests.get(sub_url)
                decoded = base64.b64decode(response.text).decode('utf-8')
                return [line for line in decoded.splitlines() if line.startswith('vmess://')]

            def parse_vmess(self, link):
                config_str = base64.b64decode(link[8:]).decode('utf-8')
                config = json.loads(config_str)
                return {
                    "name": config["ps"],
                    "type": "vmess",
                    "server": config["add"],
                    "port": config["port"],
                    "uuid": config["id"],
                    "alterId": config["aid"],
                    "cipher": "auto",
                    "tls": config.get("tls") == "tls",
                    "network": config.get("net", "tcp")
                }

            def load_rules(self):
                rules = []
                for url in self.RULE_SOURCES:
                    try:
                        response = requests.get(url, timeout=10)
                        rules.extend([
                            line.replace("IP-CIDR", "GEOIP")
                            for line in response.text.splitlines()
                            if not line.startswith('#') and line.strip()
                        ])
                    except Exception as e:
                        print(f"è§„åˆ™æº {url} åŠ è½½å¤±è´¥: {str(e)}")
                
                # æ·»åŠ æ ¸å¿ƒè§„åˆ™
                rules += [
                    "GEOIP,CN,ğŸ¯ å…¨çƒç›´è¿",
                    "MATCH,ğŸš€ èŠ‚ç‚¹é€‰æ‹©"
                ]
                return list(dict.fromkeys(rules))  # å»é‡

            def generate(self):
                vmess_links = self.fetch_subscription()
                self.config["proxies"] = [self.parse_vmess(link) for link in vmess_links]
                self.config["proxy-groups"][0]["proxies"] = [p["name"] for p in self.config["proxies"]]
                self.config["rules"] = self.load_rules()

                with open("sub/config.yaml", "w") as f:
                    yaml.dump(self.config, f, allow_unicode=True, width=2147483647)

        if __name__ == "__main__":
            generator = ClashGenerator()
            generator.generate()
        EOF

        python generate_config.py

    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        # åŸºç¡€ç»“æ„æ£€æŸ¥
        if ! grep -q 'proxies:' sub/config.yaml || ! grep -q 'proxy-groups:' sub/config.yaml; then
          echo "::error::é…ç½®æ–‡ä»¶ç»“æ„ä¸å®Œæ•´"
          exit 1
        fi

        # èŠ‚ç‚¹æ•°é‡æ£€æŸ¥
        node_count=$(grep -c 'name:' sub/config.yaml)
        if [ "$node_count" -lt 3 ]; then
          echo "::error::æœ‰æ•ˆèŠ‚ç‚¹ä¸è¶³: $node_count"
          exit 1
        fi

        # è§„åˆ™å®Œæ•´æ€§æ£€æŸ¥
        required_rules=("GEOIP,CN" "MATCH")
        for rule in "${required_rules[@]}"; do
          if ! grep -q "$rule" sub/config.yaml; then
            echo "::error::ç¼ºå¤±å¿…è¦è§„åˆ™: $rule"
            exit 1
          fi
        done

    - name: åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: sub/config.yaml
        tag_name: ${{ env.TAG_NAME }}
        name: "Clash Config ${{ env.CURRENT_DATE }}"
        generate_release_notes: true
        draft: false
        body: |
          è‡ªåŠ¨ç”Ÿæˆçš„ Clash é…ç½®æ–‡ä»¶
          - åŒ…å« $(grep -c 'name:' sub/config.yaml) ä¸ªèŠ‚ç‚¹
          - æœ€åæ›´æ–°: ${{ env.CURRENT_DATE }}
          - è§„åˆ™æ•°é‡: $(grep -c 'rules:' sub/config.yaml)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ¸…ç†å·¥ä½œåŒº
      run: |
        rm -rf nodes.txt generate_config.py
