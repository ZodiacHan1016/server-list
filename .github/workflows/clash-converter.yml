name: Clash 配置生成器

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时运行一次

jobs:
  build-config:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: 生成时间戳
      id: timestamp
      run: |
        current_date=$(date -u +'%Y%m%d-%H%M%S')
        echo "CURRENT_DATE=$current_date" >> $GITHUB_ENV
        echo "TAG_NAME=config-$current_date" >> $GITHUB_ENV

    - name: 验证时间戳格式
      run: |
        if [[ ! "$TAG_NAME" =~ ^config-[0-9]{8}-[0-9]{6}$ ]]; then
          echo "::error::时间戳格式错误: $TAG_NAME"
          exit 1
        fi

    - name: 更新 subconverter
      run: |
        git submodule update --init --remote utils/subconverter
        cd utils/subconverter
        git checkout v0.7.2
        git restore pref.ini

    - name: 准备订阅数据
      run: |
        curl -sL "https://raw.githubusercontent.com/Pawdroid/Free-servers/main/sub" | base64 -d > nodes.txt
        awk '{print "vmess://" $0}' nodes.txt > utils/subconverter/input.txt
        echo "成功获取节点数：$(wc -l < nodes.txt)"

    - name: 配置 subconverter
      run: |
        cd utils/subconverter
        sed -i.bak \
          -e "s/enable_rule_generator=.*/enable_rule_generator=true/" \
          -e "s/overwrite_original_rules=.*/overwrite_original_rules=true/" \
          config/rule.ini
        
        sed -i.bak \
          -e "s/^enable_insert=.*/enable_insert=true/" \
          -e "s|^insert_url=.*|insert_url=input.txt|" \
          -e "s/^exclude_remarks=.*/exclude_remarks=(到期|剩余流量|时间|官网|产品|平台)/" \
          pref.ini

    - name: 生成配置文件
      run: |
        cd utils/subconverter
        chmod +x subconverter-linux-amd64
        
        timeout 300 ./subconverter-linux-amd64 \
          --artifact "clash" \
          --rule "config/rule.ini" \
          --pref "pref.ini" \
          --output "../../sub/config.yaml" \
          --daemon &
        
        wait $!
        
        if [ $? -eq 124 ]; then
          echo "::error::配置生成超时"
          exit 1
        fi

        echo -e "\n# 生成时间: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> ../../sub/config.yaml
        echo "# Subconverter版本: $(git rev-parse --short HEAD)" >> ../../sub/config.yaml

    - name: 验证配置文件
      run: |
        if ! grep -q 'proxies:' sub/config.yaml || ! grep -q 'proxy-groups:' sub/config.yaml; then
          echo "::error::配置文件结构不完整"
          exit 1
        fi

        required_rules=("GEOIP,CN" "MATCH")
        for rule in "${required_rules[@]}"; do
          if ! grep -q "$rule" sub/config.yaml; then
            echo "::error::缺失关键规则: $rule"
            exit 1
          fi
        done

        node_count=$(grep -c 'vmess://' sub/config.yaml)
        if [ "$node_count" -lt 5 ]; then
          echo "::error::有效节点数量不足: 当前 $node_count 个"
          exit 1
        fi

    - name: 创建版本发布
      uses: softprops/action-gh-release@v1
      with:
        files: sub/config.yaml
        tag_name: ${{ env.TAG_NAME }}
        name: "Clash Config ${{ env.CURRENT_DATE }}"
        generate_release_notes: true
        draft: false
        body: |
          自动生成的 Clash 配置文件
          - 包含 ${{ env.NODE_COUNT }} 个节点
          - 最后更新: ${{ env.CURRENT_DATE }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NODE_COUNT: $(grep -c 'vmess://' sub/config.yaml)
        CURRENT_DATE: ${{ env.CURRENT_DATE }}
