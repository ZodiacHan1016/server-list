name: Clash Config Converter

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹æ‰§è¡Œ
  workflow_dispatch:

jobs:
  convert-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install pyyaml requests

    - name: Convert config
      run: |
        # ä¸‹è½½è®¢é˜…
        curl -s -o raw_sub.txt "https://ghproxy.com/https://raw.githubusercontent.com/Pawdroid/Free-servers/main/sub"

        # å†…è”Pythonè„šæœ¬ï¼ˆä¿®å¤ç‰ˆï¼‰
        python3 <<EOF
        import yaml
        import base64
        import json
        import requests
        import re

        def safe_b64decode(data):
            # è‡ªåŠ¨è¡¥å…¨Base64å¡«å……
            missing_padding = len(data) % 4
            if missing_padding:
                data += '=' * (4 - missing_padding)
            # å¤„ç†URLå®‰å…¨ç¼–ç 
            data = data.replace('-', '+').replace('_', '/')
            return base64.b64decode(data)

        # è¯»å–åŸå§‹è®¢é˜…
        with open('raw_sub.txt', 'r') as f:
            content = f.read().strip()
            print(f"åŸå§‹å†…å®¹é•¿åº¦: {len(content)}")  # è°ƒè¯•æ—¥å¿—

        try:
            # æ”¹è¿›çš„è§£ç æ–¹å¼
            decoded = safe_b64decode(content).decode('utf-8')
            print("è§£ç æˆåŠŸ")  # è°ƒè¯•æ—¥å¿—
        except Exception as e:
            print(f"è§£ç å¤±è´¥: {str(e)}")
            # å°è¯•ç›´æ¥ä½¿ç”¨åŸå§‹å†…å®¹
            decoded = content
            if not decoded:
                raise ValueError("è®¢é˜…å†…å®¹ä¸ºç©º")
                
        # Base64è§£ç 
        decoded = base64.b64decode(content).decode('utf-8')

        # ç”ŸæˆClashé…ç½®æ¡†æ¶
        clash_config = {
            'port': 7890,
            'socks-port': 7891,
            'mode': 'Rule',
            'log-level': 'info',
            'external-controller': '0.0.0.0:9090',
            'proxies': [],
            'proxy-groups': [],
            'rules': []
        }

        # è§£æèŠ‚ç‚¹é…ç½®
        proxies = []
        for line in decoded.split('\n'):
            if line.startswith('vmess://'):
                try:
                    config_str = base64.b64decode(line[8:]).decode('utf-8')
                    config = json.loads(config_str)
                    proxy = {
                        'name': config['ps'],
                        'type': 'vmess',
                        'server': config['add'],
                        'port': config['port'],
                        'uuid': config['id'],
                        'alterId': config['aid'],
                        'cipher': 'auto'
                    }
                    proxies.append(proxy)
                except Exception as e:
                    print(f"è§£æå¤±è´¥: {str(e)}")

        # æ„å»ºå®Œæ•´ä»£ç†ç»„ï¼ˆå…¼å®¹rule.iniï¼‰
        proxy_groups = [
            # ä¸»è¦ä»£ç†ç»„
            {
                'name': 'ğŸš€ èŠ‚ç‚¹é€‰æ‹©',
                'type': 'select',
                'proxies': ['â™»ï¸ è‡ªåŠ¨é€‰æ‹©', 'DIRECT'] + [p['name'] for p in proxies]
            },
            {
                'name': 'â™»ï¸ è‡ªåŠ¨é€‰æ‹©',
                'type': 'url-test',
                'url': 'http://www.gstatic.com/generate_204',
                'interval': 300,
                'proxies': [p['name'] for p in proxies]
            },
            # åœ°åŒºç»„
            {
                'name': 'ğŸŒ åŒ—ç¾åœ°åŒº',
                'type': 'url-test',
                'url': 'http://www.gstatic.com/generate_204',
                'interval': 300,
                'proxies': [p['name'] for p in proxies if 'ç¾' in p['name'] or 'US' in p['name']]
            },
            # å…¶ä»–åœ°åŒºç»„...
            # æœåŠ¡ç»„
            {
                'name': 'ğŸ“º å›½å¤–åª’ä½“',
                'type': 'select',
                'proxies': ['ğŸš€ èŠ‚ç‚¹é€‰æ‹©', 'ğŸŒ åŒ—ç¾åœ°åŒº', 'DIRECT']
            },
            {
                'name': 'â“‚ï¸ å¾®è½¯æœåŠ¡',
                'type': 'select',
                'proxies': ['DIRECT', 'ğŸš€ èŠ‚ç‚¹é€‰æ‹©']
            },
            # ç³»ç»Ÿç»„
            {
                'name': 'ğŸ¯ å…¨çƒç›´è¿',
                'type': 'select',
                'proxies': ['DIRECT']
            },
            {
                'name': 'ğŸ›‘ å…¨çƒæ‹¦æˆª',
                'type': 'select',
                'proxies': ['REJECT', 'DIRECT']
            }
        ]

        # åŠ¨æ€è§„åˆ™æºï¼ˆå¢å¼ºREJECT/DIRECTè§„åˆ™ï¼‰
        rule_sources = {
            # ç›´è¿è§„åˆ™
            'DIRECT': [
                'https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/China/China.list',
                'https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaIP/ChinaIP.list'
            ],
            # ä»£ç†è§„åˆ™
            'PROXY': [
                'https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Proxy/Proxy.list',
                'https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Global/Global.list'
            ],
            # æ‹¦æˆªè§„åˆ™
            'REJECT': [
                'https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Advertising/Advertising.list',
                'https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Privacy/Privacy.list'
            ]
        }

        # æ„å»ºè§„åˆ™é“¾ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰
        rules = [
            # æœ€é«˜ä¼˜å…ˆçº§ï¼šç›´è¿è§„åˆ™
            'GEOIP,CN,DIRECT',
            'DOMAIN-KEYWORD,edu,DIRECT',
            *[f'{rule},DIRECT' for url in rule_sources['DIRECT'] for rule in fetch_ruleset(url)],
            
            # å…¶æ¬¡ï¼šä»£ç†è§„åˆ™
            *[f'{rule},ğŸš€ èŠ‚ç‚¹é€‰æ‹©' for url in rule_sources['PROXY'] for rule in fetch_ruleset(url)],
            
            # ç„¶åï¼šæœåŠ¡ç‰¹å®šè§„åˆ™
            'DOMAIN-SUFFIX,microsoft.com,â“‚ï¸ å¾®è½¯æœåŠ¡',
            'DOMAIN-SUFFIX,apple.com,DIRECT',
            
            # æ‹¦æˆªè§„åˆ™
            *[f'{rule},REJECT' for url in rule_sources['REJECT'] for rule in fetch_ruleset(url)],
            
            # æœ€ç»ˆè§„åˆ™
            'MATCH,ğŸŸ æ¼ç½‘ä¹‹é±¼'  # ä¿æŒä¸rule.iniä¸€è‡´
        ]

        # åˆå¹¶é…ç½®
        clash_config.update({
            'proxies': proxies,
            'proxy-groups': proxy_groups,
            'rules': rules
        })

        # ä¿å­˜é…ç½®æ–‡ä»¶
        with open('./sub/config.yaml', 'w') as f:
            yaml.dump(clash_config, f, allow_unicode=True, sort_keys=False)
        EOF

    - name: Commit and push
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git pull origin master
        git add ./sub/config.yaml
        git commit -m "Auto update Clash config [$(date +'%Y-%m-%d')]" || echo "No changes"
        git push
